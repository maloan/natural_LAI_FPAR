---
title: "Natural-Vegetation LAI/FPAR Masking & Aggregation — Workflow Vignette"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    toc: true
    toc_depth: 3
    number_sections: true
  pdf_document:
    toc: true
---

## **1. Purpose**

This document outlines a reproducible workflow to construct natural-vegetation masks at 0.05°, apply them to monthly LAI/FPAR fields, aggregate masked products to 0.25°, and evaluate the resulting datasets. The pipeline supports multiple mask families:

-   **CCI used-land mask** (τ–k thresholds)
-   **GLC used≥N years mask** (temporal persistence)
-   **LUH pasture–grass overlap mask**
-   **Static abiotic masks** (water/ice/bare)

Individual steps are implemented as small scripts using shared utilities (`utils.R`, `geom.R`, `io.R`, `viz.R`, `options.R`, `names.R`). All components run non-interactively and scale to HPC.

------------------------------------------------------------------------

## **2. Minimal setup**

``` r
Sys.setenv(SNU_LAI_FPAR_ROOT = "~/GitHub/natural_LAI_FPAR")

suppressPackageStartupMessages({
  library(terra)
  library(yaml)
  library(glue)
  library(stringr)
  library(tidyverse)
})
```

------------------------------------------------------------------------

## **3. Configuration**

Edit `config/config.yml` to define:

-   **paths**: raw data, intermediate outputs, masked outputs, visualisation directory
-   **grids**: canonical 0.05° and 0.25° grids, including consistent area rasters
-   **project years**: e.g., CCI: 1992–2020
-   **dataset descriptors**: GLC classes, CCI classes, LUH variables

Inspect configuration:

``` r
ROOT <- Sys.getenv("SNU_LAI_FPAR_ROOT")
CFG  <- yaml::read_yaml(file.path(ROOT, "config", "config.yml"))
str(CFG$paths)
str(CFG$grids)
CFG$project$years
```

------------------------------------------------------------------------

## **4. Environment flags**

Flags control masking parameters, overwrite behaviour, quicklooks, and LUH rules. All accept `TRUE/FALSE`, `1/0`, or `yes/no`.

### Available flags

-   `SKIP_EXISTING`
-   `OVERWRITE`
-   `REMAKE_QL`
-   `USED_N_YEARS`
-   `TAU_CCI`, `K_CCI`, `CCI_BAND`
-   `TAU_WATER`, `TAU_ICE`, `TAU_BARE`
-   `GRASS_SOURCE` (`CCI | GLC_FRAC`)
-   `G_MIN`, `P_MIN`, `ALPHA`
-   `LUH_AVG_START`, `LUH_AVG_END`

Example:

``` r
Sys.setenv(
  SKIP_EXISTING="TRUE", OVERWRITE="FALSE", REMAKE_QL="TRUE",
  USED_N_YEARS="3",
  TAU_CCI="0.10", K_CCI="3", CCI_BAND="frac_fused",
  TAU_WATER="0.05", TAU_ICE="0.05", TAU_BARE="0.30",
  GRASS_SOURCE="CCI", G_MIN="0.05", P_MIN="0.20", ALPHA="0.50",
  LUH_AVG_START="1992", LUH_AVG_END="2020"
)
```

------------------------------------------------------------------------

## **5. Workflow overview**

### **1. Mask construction (0.05°)**

-   **GLC used≥N mask** `04_glc_mask_0p05.R`

-   **Abiotic masks** `05_abiotic_static_from_cci_0p05.R` `05_abiotic_static_from_glc_0p05.R`

-   **LUH pasture & overlap masks** `07_luh_use_masks.R` `04_luh_pasture_overlap_025.R` (0.25° + 0.05° replica)

### **2. Apply masks to LAI/FPAR**

-   `07_apply_mask_0p05.R` Applies CCI/GLC masks, abiotic overlays, and LUH overlap mask.

### **3. Aggregate to 0.25°**

-   `08_agg_0p25.R` Area-weighted aggregation.

### **4. Evaluate**

-   `10_eval_masks.R` Mask statistics, Jaccard, sensitivities.

-   `11_eval_outputs.R` Figures and diagnostics.

------------------------------------------------------------------------

## **6. Running scripts directly from R**

``` r
root <- Sys.getenv("SNU_LAI_FPAR_ROOT")

run <- function(script, env=list()) {
  old <- Sys.getenv(names(env), unset = NA_character_)
  on.exit(mapply(Sys.setenv, names(old), as.list(old)), add=TRUE)
  mapply(Sys.setenv, names(env), as.list(env))
  system2("Rscript", c(file.path(root, "R", script)))
}
```

Example workflow (commented):

``` r
# run("04_glc_mask_0p05.R", env=c(USED_N_YEARS="3"))

# run("05_abiotic_static_from_cci_0p05.R",
#     env=c(TAU_WATER="0.05", TAU_ICE="0.05", TAU_BARE="0.30"))

# run("07_luh_use_masks.R", env=c(LUH_AVG_START="1992", LUH_AVG_END="2020"))

# run("04_luh_pasture_overlap_025.R",
#     env=c(GRASS_SOURCE="CCI", G_MIN="0.05", P_MIN="0.20", ALPHA="0.50"))

# run("07_apply_mask_0p05.R",
#     env=c(VAR="FPAR", MASK="CCI",
#            APPLY_ABIOTIC_STATIC="TRUE", APPLY_LUH_OVERLAP="TRUE"))

# run("08_agg_0p25.R", env=c(VAR="FPAR", MASK="CCI"))

# run("10_eval_masks.R")
# run("11_eval_outputs.R")
```

------------------------------------------------------------------------

## **7. Inspecting outputs**

``` r
CFG <- yaml::read_yaml(file.path(root,"config","config.yml"))

m_cci <- rast(list.files(CFG$paths$masks_cci_dir,
                         "mask_used_.*0p05.tif$", full.names=TRUE)[1])
m_glc <- rast(list.files(CFG$paths$masks_glc_dir,
                         "mask_used_ge\\d+_.*0p05.tif$", full.names=TRUE)[1])

plot(m_cci, col=c("#f0f0f0","#d73027"), breaks=c(-0.5,0.5,1.5),
     main="CCI used-mask (1 = drop)")
plot(m_glc, col=c("#f0f0f0","#d73027"), breaks=c(-0.5,0.5,1.5),
     main="GLC used≥N (1 = drop)")
```

------------------------------------------------------------------------

## **8. Reproducibility notes**

-   Masks use a **byte representation** (`1 = drop`, `0 = keep`, `NA = 255` on disk).

-   Resampling rules:

    -   categorical → *nearest neighbour*
    -   continuous → *bilinear*
    -   aggregation uses **explicit 0.05° area weights**

-   File naming follows strict parameter tokens (`tau0p10_k3`, `Gmin0p05_Pmin0p20_alpha0p50`).

-   Provenance metadata embedded via `io.R::gtiff_desc()`.

-   Scripts generate global/AOI quicklooks for rapid QA.

------------------------------------------------------------------------
